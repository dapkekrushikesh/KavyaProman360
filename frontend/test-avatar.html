<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avatar Button Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4f46e5;
    }
    pre {
      background: #f8f8f8;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .status-icon {
      font-size: 24px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>üß™ Avatar Upload Button Test</h1>
  <p>This page tests if the avatar buttons are working correctly on your Settings page.</p>

  <div class="test-section">
    <h2>Step 1: Open Settings Page</h2>
    <p>First, make sure you have the Settings page open in another tab.</p>
    <button onclick="openSettings()">Open Settings Page</button>
  </div>

  <div class="test-section">
    <h2>Step 2: Run Automated Tests</h2>
    <button onclick="runTests()">Run All Tests</button>
    <div id="testResults"></div>
  </div>

  <div class="test-section">
    <h2>Step 3: Manual Testing Checklist</h2>
    <div id="checklist">
      <label><input type="checkbox"> Upload button is disabled initially</label><br>
      <label><input type="checkbox"> Selected a valid image file</label><br>
      <label><input type="checkbox"> Preview appeared immediately</label><br>
      <label><input type="checkbox"> Upload button became enabled</label><br>
      <label><input type="checkbox"> Clicked Upload Avatar</label><br>
      <label><input type="checkbox"> Loading spinner appeared</label><br>
      <label><input type="checkbox"> Success message displayed</label><br>
      <label><input type="checkbox"> Page reloaded automatically</label><br>
      <label><input type="checkbox"> Avatar appears in profile modal</label><br>
      <label><input type="checkbox"> Remove button works with confirmation</label><br>
    </div>
  </div>

  <div class="test-section">
    <h2>Step 4: Backend Tests</h2>
    <button onclick="testBackend()">Test Backend Connection</button>
    <div id="backendResults"></div>
  </div>

  <script>
    function openSettings() {
      const path = window.location.pathname;
      const dir = path.substring(0, path.lastIndexOf('/'));
      window.open(dir + '/setting.html', '_blank');
    }

    async function runTests() {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '<p>Running tests...</p>';
      
      let results = [];
      let passed = 0;
      let failed = 0;

      // Test 1: Check if files exist
      try {
        const response = await fetch('assests/js/setting.js');
        if (response.ok) {
          results.push('‚úÖ setting.js file exists');
          passed++;
        } else {
          results.push('‚ùå setting.js file not found');
          failed++;
        }
      } catch (e) {
        results.push('‚ùå Could not check setting.js: ' + e.message);
        failed++;
      }

      // Test 2: Check if config.js exists
      try {
        const response = await fetch('assests/js/config.js');
        if (response.ok) {
          results.push('‚úÖ config.js file exists');
          passed++;
        } else {
          results.push('‚ùå config.js file not found');
          failed++;
        }
      } catch (e) {
        results.push('‚ùå Could not check config.js: ' + e.message);
        failed++;
      }

      // Test 3: Check localStorage for token
      const token = localStorage.getItem('token');
      if (token) {
        results.push('‚úÖ Authentication token found in localStorage');
        passed++;
      } else {
        results.push('‚ö†Ô∏è No authentication token - you need to login first');
        failed++;
      }

      // Test 4: Check if setting.html exists
      try {
        const response = await fetch('setting.html');
        if (response.ok) {
          const html = await response.text();
          if (html.includes('setting.js')) {
            results.push('‚úÖ setting.html includes setting.js script');
            passed++;
          } else {
            results.push('‚ùå setting.html does NOT include setting.js script');
            failed++;
          }
        }
      } catch (e) {
        results.push('‚ùå Could not check setting.html: ' + e.message);
        failed++;
      }

      // Display results
      resultsDiv.innerHTML = `
        <h3>Test Results</h3>
        <p class="success">‚úÖ Passed: ${passed}</p>
        <p class="error">‚ùå Failed: ${failed}</p>
        <pre>${results.join('\n')}</pre>
      `;
    }

    async function testBackend() {
      const resultsDiv = document.getElementById('backendResults');
      resultsDiv.innerHTML = '<p>Testing backend...</p>';
      
      let results = [];
      const API_URL = window.API_CONFIG?.BASE_URL || 'http://localhost:3000';

      // Test 1: Health endpoint
      try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        if (response.ok) {
          results.push('‚úÖ Backend is running');
          results.push(`   Status: ${data.status}`);
          results.push(`   Environment: ${data.environment}`);
        } else {
          results.push('‚ùå Backend health check failed');
        }
      } catch (e) {
        results.push('‚ùå Cannot connect to backend: ' + e.message);
        results.push('   Make sure backend is running on ' + API_URL);
      }

      // Test 2: Auth endpoint
      const token = localStorage.getItem('token');
      if (token) {
        try {
          const response = await fetch(`${API_URL}/api/auth/me`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();
          if (response.ok) {
            results.push('‚úÖ Authentication endpoint working');
            results.push(`   User: ${data.user.name || data.user.email}`);
            results.push(`   Avatar: ${data.user.avatar || 'None'}`);
          } else {
            results.push('‚ùå Authentication failed: ' + data.message);
          }
        } catch (e) {
          results.push('‚ùå Auth endpoint error: ' + e.message);
        }
      } else {
        results.push('‚ö†Ô∏è Skipping auth test - no token found');
      }

      resultsDiv.innerHTML = `<pre>${results.join('\n')}</pre>`;
    }

    // Load config
    const script = document.createElement('script');
    script.src = 'assests/js/config.js';
    script.onerror = () => {
      console.error('Could not load config.js');
    };
    document.head.appendChild(script);
  </script>
</body>
</html>
